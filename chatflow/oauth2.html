

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>OAuth2/Uber Tutorials &mdash; ChatFlow 0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="ChatFlow 0.1 documentation" href="index.html"/>
        <link rel="next" title="Line Bot Tutorials" href="line.html"/>
        <link rel="prev" title="Alexa Echo Show Skill Tutorials" href="alexa_show.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            
              <a href="http://chatflow.kitt.ai" target="_blank" class="icon icon-home"> ChatFlow
            
          

          
            
            <img src="_static/chatflow-logo.png" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference external" href="../cn/html/index.html#://">中文版</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Welcome to ChatFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">ChatFlow Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_a_bot.html">ChatFlow Build A Bot Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="dialogue_nodes.html">Dialogue Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Debug ChatFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="extended_example.html">Extended Example: A Conversational Yelp Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="telegram.html">Telegram Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="facebook.html">Facebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="slack.html">Slack Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="twilio.html">Twilio Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="kik.html">Kik Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="skype.html">Skype Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="alexa.html">Alexa Skill Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="alexa_advanced.html">Advanced Alexa Skill Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="alexa_nlu.html">Advanced Alexa Skill NLU Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="alexa_show.html">Alexa Echo Show Skill Tutorials</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">OAuth2/Uber Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#uber-oauth2-video-tutorial">Uber Oauth2 Video Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simple-descripton-of-oauth2-flow">Simple Descripton of OAuth2 Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-an-uber-access-bot">Creating an Uber Access Bot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#registering-an-application-in-uber-service">Registering an application in Uber service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-bot">1. Creating the bot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-the-oauth2-node">2. Configuring the OAuth2 Node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-application">3. Testing the Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reusing-access-tokens">4. Reusing Access Tokens</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="line.html">Line Bot Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ChatFlow</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>OAuth2/Uber Tutorials</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          <a href="../cn/html/index.html" class="fa fa-book" style="color:#55507c" target="_blank"> 中文版</a>
        
        
          <a href="https://groups.google.com/a/kitt.ai/forum/#!forum/chat" class="fa fa-comments" style="color:#55507c" target="_blank"> Forum</a>
        
        
            
            <a href="_sources/oauth2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="oauth2-uber-tutorials">
<span id="oauth2"></span><h1><a class="toc-backref" href="#id1">OAuth2/Uber Tutorials</a><a class="headerlink" href="#oauth2-uber-tutorials" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#oauth2-uber-tutorials" id="id1">OAuth2/Uber Tutorials</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a><ul>
<li><a class="reference internal" href="#uber-oauth2-video-tutorial" id="id3">Uber Oauth2 Video Tutorial</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simple-descripton-of-oauth2-flow" id="id4">Simple Descripton of OAuth2 Flow</a></li>
<li><a class="reference internal" href="#creating-an-uber-access-bot" id="id5">Creating an Uber Access Bot</a><ul>
<li><a class="reference internal" href="#registering-an-application-in-uber-service" id="id6">Registering an application in Uber service</a></li>
<li><a class="reference internal" href="#creating-the-bot" id="id7">1. Creating the bot</a></li>
<li><a class="reference internal" href="#configuring-the-oauth2-node" id="id8">2. Configuring the OAuth2 Node</a></li>
<li><a class="reference internal" href="#testing-the-application" id="id9">3. Testing the Application</a></li>
<li><a class="reference internal" href="#reusing-access-tokens" id="id10">4. Reusing Access Tokens</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we use OAuth2 Request node to make HTTP(S) requests requiring OAuth2
app authentication with user authorization. OAuth2 authorization is helpful when your bot
needs to take actions on behalf of the user.</p>
<dl class="docutils">
<dt>This tutorial assumes:</dt>
<dd><ul class="first last simple">
<li>you know how to create applications</li>
<li>you know how to add nodes</li>
<li>you have an Uber account</li>
</ul>
</dd>
<dt>By the end of this tutorial, you will be able to:</dt>
<dd><ul class="first last simple">
<li>Configure Oauth2 Nodes</li>
<li>Test the Oauth2 authorization</li>
<li>Reuse Access Tokens</li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The OAuth2 request node is only usable in scenarios when a user has an access to a browser and can
open links provided by an application. For example: using it in an app that communicates with
SMS messages may not be a good idea, because some old feature phones don’t have any web browsers or
users don’t want to or can’t use their data connection.</p>
</div>
<div class="section" id="uber-oauth2-video-tutorial">
<h3><a class="toc-backref" href="#id3">Uber Oauth2 Video Tutorial</a><a class="headerlink" href="#uber-oauth2-video-tutorial" title="Permalink to this headline">¶</a></h3>
<p>Here is a video tutorial walking you through the Uber Oauth2 configuration process:</p>
<iframe width="640" height="360" src="https://www.youtube.com/embed/ElKDTwMxKnU"
   frameborder="0" allowfullscreen></iframe>
<br><br><br></div>
</div>
<div class="section" id="simple-descripton-of-oauth2-flow">
<h2><a class="toc-backref" href="#id4">Simple Descripton of OAuth2 Flow</a><a class="headerlink" href="#simple-descripton-of-oauth2-flow" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>The application asks the service to provide access credentials for user account and given scope of data/resources,
by asking the user to open a specially crafted link in a browser. The link opens a page provided by the service.</li>
<li>If the user accepts, then the service redirects the browser to a predefined application page,
passing a special one-use token.</li>
<li>The application exchanges the received one-use token for a multi-use access token (using the service, via server-to-server request).</li>
<li>The application can use the access token to make requests that retrieve user-related resources.</li>
</ol>
<p>The access token can be used many times, but can expire. The expiration time can be as short as one
hour or as long as one month (there is no rule, you have to check the service documentation).</p>
<p>The service can provide a special refresh token that can be used to get a new access token without user interaction.
This token can expire too (it’s service-dependent).</p>
<p>The OAuth2 Request node manages token acqusition and refreshing automatically.</p>
</div>
<div class="section" id="creating-an-uber-access-bot">
<h2><a class="toc-backref" href="#id5">Creating an Uber Access Bot</a><a class="headerlink" href="#creating-an-uber-access-bot" title="Permalink to this headline">¶</a></h2>
<div class="section" id="registering-an-application-in-uber-service">
<h3><a class="toc-backref" href="#id6">Registering an application in Uber service</a><a class="headerlink" href="#registering-an-application-in-uber-service" title="Permalink to this headline">¶</a></h3>
<p>Go to <a class="reference external" href="https://developer.uber.com/dashboard">Uber Developer Dashboard</a>. Press the “+New App” button.
Select “Rides API”, enter your app name, description, read the terms and if you agree with them,
fill the corresponding checkbox, press the “Create” button. That’s all (for now), we’ll be back here later.</p>
</div>
<div class="section" id="creating-the-bot">
<h3><a class="toc-backref" href="#id7">1. Creating the bot</a><a class="headerlink" href="#creating-the-bot" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Create a new application.</li>
<li>Add the following nodes to the flow:
- Chat In
- Chat Out
- router
- 3x enter
- function
- OAuth2 Request
- 4x state (yes, one more than enter states)</li>
<li>Connect the nodes in the following manner:</li>
</ol>
<img alt="_images/oauth2-connected.png" class="align-center" src="_images/oauth2-connected.png" />
<ol class="arabic simple" start="4">
<li>Edit the first enter node, name it “start”, remove the existing (empty) condition and check the “Initial state” option.
Skip the first state node.</li>
</ol>
<img alt="_images/oauth2-start.png" class="align-center" src="_images/oauth2-start.png" />
<ol class="arabic simple" start="5">
<li>Edit the second enter node, name it “get profile”, let it check the payload for <code class="docutils literal notranslate"><span class="pre">profile</span></code>.</li>
</ol>
<img alt="_images/oauth2-enter-get-profile.png" class="align-center" src="_images/oauth2-enter-get-profile.png" />
<ol class="arabic simple" start="6">
<li>Edit the function node, name it “clear payload” and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/oauth2-func-clear-payload.png" class="align-center" src="_images/oauth2-func-clear-payload.png" />
</div>
<div class="section" id="configuring-the-oauth2-node">
<h3><a class="toc-backref" href="#id8">2. Configuring the OAuth2 Node</a><a class="headerlink" href="#configuring-the-oauth2-node" title="Permalink to this headline">¶</a></h3>
<p>Now comes the fun part, we’ll set up the OAuth2 Request node, so double click it to open the editor.</p>
<ol class="arabic simple">
<li>Name the Oauth 2 “uber profile”</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">profile</span> <span class="pre">history</span> <span class="pre">places</span></code> in the “Scopes” field.</li>
<li>Set method to <code class="docutils literal notranslate"><span class="pre">GET</span></code>.</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">https://api.uber.com/v1/me</span></code> in the URL field.</li>
</ol>
<img alt="_images/oauth2-uber-req.png" class="align-center" src="_images/oauth2-uber-req.png" />
<p>Upon user authorization, the URL field will immediately make a request to <code class="docutils literal notranslate"><span class="pre">https://api.uber.com/v1/me</span></code>
and fetch your profile information.  You can optionally leave this field empty, then upon user authorization
the OAuth2 node will just output obtained credentials specificed in the next step (by default to <code class="docutils literal notranslate"><span class="pre">msg.kitt.oauth2</span></code>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Credentials are stored by assigning them to defined scopes. If you have many OAuth2 Request nodes in the same app
(or even in many apps if they share OAuth2 credentials),
you may want to use the biggest common set of scopes, so user will have to authorize your app only once
(and give access every piece of data you want at once).</p>
</div>
<ol class="arabic simple" start="5">
<li>Click on the pencil icon in the “Configuration” line to add a new configuration:</li>
<li>Name it “uber”.</li>
<li>Go to the <a class="reference external" href="https://developer.uber.com/dashboard">Uber Developer Dashboard</a>,
open your application details, copy “Client ID” and “Client secret” to OAuth2 Configuration in ChatFlow,</li>
</ol>
<img alt="_images/oauth2-uber-creds.png" class="align-center" src="_images/oauth2-uber-creds.png" />
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Don’t try to copy those values from this tutorial, data shown here is fake.</p>
</div>
<ol class="arabic simple" start="8">
<li>Enter <code class="docutils literal notranslate"><span class="pre">https://login.uber.com</span></code> in the “Authorization host” field.</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">/oauth/v2/authorize</span></code> in the “Authorization endpoint” field.</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">/oauth/v2/token</span></code> in the “Token exchange endpoint” field.</li>
<li>Change the “Where credentials are kept” value to <code class="docutils literal notranslate"><span class="pre">kitt.oauth2</span></code></li>
<li>Click on the gray “Redirect URL” field to copy its value to your clipboard.</li>
<li>You can save settings in both dialog windows now.</li>
</ol>
<img alt="_images/oauth2-uber-config.png" class="align-center" src="_images/oauth2-uber-config.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OAuth2 request node tries to reuse credentials it obtained in the past, so the user isn’t bothered
with clicking on links on each request. The acquired credentials are kept in the specified property
of a message. By using the value <code class="docutils literal notranslate"><span class="pre">kitt.oauth2</span></code>, we can keep those credentials in the “dialogue” (session) storage.
You can use the data saved in this property to keep credentials in some more persistent storage (like a database).</p>
</div>
<ol class="arabic simple" start="14">
<li>Go to your application in “Uber Developer Dashboard”, switch to “Authorizations” tab and paste the address you copied
into the “Redirect URL” field. You also have to enter any valid http address in the “Privacy policy url” (it’s a required field).</li>
</ol>
<img alt="_images/oauth2-uber-redirect.png" class="align-center" src="_images/oauth2-uber-redirect.png" />
<ol class="arabic simple" start="15">
<li>Enable <code class="docutils literal notranslate"><span class="pre">profile</span></code>, <code class="docutils literal notranslate"><span class="pre">places</span></code> and <code class="docutils literal notranslate"><span class="pre">history</span></code> in the General Scopes section. Don’t forget to save those settings.</li>
</ol>
<img alt="_images/oauth2-uber-scopes.png" class="align-center" src="_images/oauth2-uber-scopes.png" />
<ol class="arabic simple" start="16">
<li>Edit the second state node (the one connected to the upper OAuth2 output), name it “authorize app”
and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">_responses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Please authorize this app: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">oauth2</span><span class="p">.</span><span class="nx">url</span><span class="p">];</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/oauth2-state-authorize.png" class="align-center" src="_images/oauth2-state-authorize.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The first (upper) output of this node is used to ask the user for authorization to access his/her data.
If the OAuth2 node can use credentials (access token plus other data) that it acquired previously,
this node can proceed without asking the user to accept the access again so long
as those credentials are still valid.</p>
<p class="last">Only when the user authorizes the access, the OAuth2 request node will proceed.</p>
</div>
<ol class="arabic simple" start="17">
<li>Edit the third state node (the one connected to the lower OAuth2 output), name it “greet”
and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">_responses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">first_name</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">];</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/oauth2-state-greet.png" class="align-center" src="_images/oauth2-state-greet.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The second output of the OAuth2 Request node is used to pass the data received from the server.
It’s mostly compatible with the HTTP Request node output.</p>
</div>
<ol class="arabic simple" start="18">
<li>Edit the third enter node, name it “end conversation”, let it check the payload for <code class="docutils literal notranslate"><span class="pre">bye</span></code>.</li>
</ol>
<img alt="_images/oauth2-enter-end.png" class="align-center" src="_images/oauth2-enter-end.png" />
<ol class="arabic simple" start="19">
<li>Edit the fourth state node, name it “end”, you can leave the function body unchanged, set the
“Output text” to <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">bye!</span></code> and enable the “Dialogue ends here” option.</li>
</ol>
<img alt="_images/oauth2-state-end.png" class="align-center" src="_images/oauth2-state-end.png" />
<p>The complete application flow should look like this:</p>
<blockquote>
<div><img alt="_images/oauth2-complete.png" class="align-center" src="_images/oauth2-complete.png" />
</div></blockquote>
<p>If you have had any problems, you can <a class="reference external" href="_static/json/oauth2-uber-chat.json">download an example application</a>,
all you have to do is fill in the “Client ID” and “Client Secret” fields.</p>
</div>
<div class="section" id="testing-the-application">
<h3><a class="toc-backref" href="#id9">3. Testing the Application</a><a class="headerlink" href="#testing-the-application" title="Permalink to this headline">¶</a></h3>
<p>Now you can test your application. Open the Chat panel and send a <code class="docutils literal notranslate"><span class="pre">profile</span></code> message.
The application should ask you to authorize its access to your data. Click on the provided link
and press “Accept” on the Uber page. After that, the application should greet you with your first name (read from your Uber profile).</p>
<p>If you send a <code class="docutils literal notranslate"><span class="pre">profile</span></code> message again, then the application will make a request again, but because it has
obtained valid credentials (access token) previously, it can do it without asking you to authorize it again.</p>
<p>When you send a <code class="docutils literal notranslate"><span class="pre">bye</span></code> message, then the dialogue (session) will end and those credentials will be forgotten.</p>
<img alt="_images/oauth2-chat.png" class="align-center" src="_images/oauth2-chat.png" />
</div>
<div class="section" id="reusing-access-tokens">
<h3><a class="toc-backref" href="#id10">4. Reusing Access Tokens</a><a class="headerlink" href="#reusing-access-tokens" title="Permalink to this headline">¶</a></h3>
<p>Now let’s assume that credentials are kept in some persistent storage and use two requests to access different resources.
For simplicity of this tutorial we won’t use any “real” storage yet.</p>
<p>1. Open the configuration editor in OAuth2 Request node and change the field named “Where credentials are kept” to <code class="docutils literal notranslate"><span class="pre">uber_oauth2</span></code>.
Data stored in <code class="docutils literal notranslate"><span class="pre">msg.kitt.*</span></code> is persisted in the dialog (session) storage by the router node, but data stored in other properties of <code class="docutils literal notranslate"><span class="pre">msg</span></code> is not.
Leave the rest of the fields unchanged.
If you deploy and test the application now, you will see that the user is asked for authorization every time we want to access his/her profile.</p>
<img alt="_images/oauth2_adv_credentials.png" class="align-center" src="_images/oauth2_adv_credentials.png" />
<ol class="arabic simple" start="2">
<li>Now add two function nodes. Connect one between the “Chat In” and the router, and another between the router and the “Chat out” node, so it will look like this:</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you drop a node from the palette on an existing connection, the connection will “split” and the new node will be automatically connected.</p>
</div>
<img alt="_images/oauth2_adv_storage.png" class="align-center" src="_images/oauth2_adv_storage.png" />
<ol class="arabic simple" start="3">
<li>Edit the function node placed before the router, name it “restore credentials” and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">msg</span><span class="p">.</span><span class="nx">uber_oauth2</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;mockDatabase&#39;</span><span class="p">);</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/oauth2_adv_restore_credentials.png" class="align-center" src="_images/oauth2_adv_restore_credentials.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We’re using the global application storage as a mock database. As you’re the only possible user of the application,
you don’t have to know which user the credentials object belong to.
In a real-world scenario you’d have to store credentials in some collection/table where the user
identifier is the (primary) key.</p>
<p class="last">This is very important, because if you do it the “wrong” way (like in this simplified example),
you will give access to protected resources to users not “owning” these resources.</p>
</div>
<ol class="arabic simple" start="4">
<li>Edit the function node placed after the router, name it “save credentials” and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">uber_oauth2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;mockDatabase&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">uber_oauth2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<img alt="_images/oauth2_adv_save_credentials.png" class="align-center" src="_images/oauth2_adv_save_credentials.png" />
<p>5. Now the application will ask for credentials <strong>only once</strong>, but let’s not stop here and let’s
add a second “command” that will access another Uber resource. Do this by adding following nodes to the flow:</p>
<blockquote>
<div><ul class="simple">
<li>enter</li>
<li>function</li>
<li>OAuth2 Request</li>
<li>state</li>
</ul>
</div></blockquote>
<p>6. Connect the new nodes like in the example below. Don’t forget to link the first output of the new OAuth2 Request node to
the existing state node called “authorize app”. Existing nodes and connections were “faded out” in the image below.</p>
<img alt="_images/oauth2_adv_new_nodes.png" class="align-center" src="_images/oauth2_adv_new_nodes.png" />
<ol class="arabic simple" start="7">
<li>Edit the added enter node, name it “get history” and let check the payload for <code class="docutils literal notranslate"><span class="pre">history</span></code>.</li>
</ol>
<img alt="_images/oauth2_adv_enter_history.png" class="align-center" src="_images/oauth2_adv_enter_history.png" />
<ol class="arabic" start="8">
<li><p class="first">Copy the contents of the existing “clear payload” function node to the new function node (so after this step there are two “clear payload” function nodes).</p>
</li>
<li><p class="first">Edit the second OAuth2 Request node like you did before:</p>
<blockquote>
<div><ol class="lowerroman simple">
<li>Name it “uber history”</li>
<li>Use the existing configration called <code class="docutils literal notranslate"><span class="pre">uber</span></code>.</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">profile</span> <span class="pre">history</span> <span class="pre">places</span></code> in the “Scopes” field (the same as those used by the first request node, this is important).</li>
<li>Set method to <code class="docutils literal notranslate"><span class="pre">GET</span></code>.</li>
<li>Enter <code class="docutils literal notranslate"><span class="pre">https://api.uber.com/v1.2/history</span></code> in the URL field.</li>
</ol>
</div></blockquote>
</li>
</ol>
<img alt="_images/oauth2_adv_request.png" class="align-center" src="_images/oauth2_adv_request.png" />
<ol class="arabic simple" start="10">
<li>Edit the last added state node, name it “print places”, and enter the following code in the function body:</li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="s1">&#39;You ordered &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; rides.&#39;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">response</span> <span class="o">+=</span> <span class="s1">&#39; The first one started in &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start_city</span><span class="p">.</span><span class="nx">display_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">_responses</span> <span class="o">=</span> <span class="p">[</span><span class="nx">response</span><span class="p">];</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/oauth2_adv_print_places.png" class="align-center" src="_images/oauth2_adv_print_places.png" />
<ol class="arabic simple" start="11">
<li>Now you can test your application again. If you authorized it after setting up the “save credentials” node, you will see that it won’t ask for authorization.
Once more - if you end the dialogue session by sending “bye”, and use commands accessing Uber resources, you will see that the app will reuse the
credentials it obtained and stored in the mock “database” (<code class="docutils literal notranslate"><span class="pre">global</span></code> object).</li>
</ol>
<img alt="_images/oauth2_adv_chat_test.png" class="align-center" src="_images/oauth2_adv_chat_test.png" />
<p>The completed application after this part should look like the one below:</p>
<img alt="_images/oauth2_adv_complete.png" class="align-center" src="_images/oauth2_adv_complete.png" />
<p>You can download the source code of this application <a class="reference download internal" href="_downloads/oauth2-uber-chat-adv.json" download=""><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="line.html" class="btn btn-neutral float-right" title="Line Bot Tutorials" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="alexa_show.html" class="btn btn-neutral" title="Alexa Echo Show Skill Tutorials" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p  style="color:#999;">
        &copy; Copyright 2016, KITT.AI.
      Last updated on Mar 16, 2018.

    </p>
  </div> 

  <div>

    <p>
      Made with <i class="fa fa-heart" style="color:red;"></i> in the city of
      <i class="fa fa-coffee" style="color:#6F4E37;"></i>
      <i class="fa fa-umbrella" style="color:#007FFF;"></i>
      <i class="fa fa-plane" style="color:#0F52BA;"></i>
      <i class="fa fa-diamond" style="color:#50C878;"></i>
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/js/anchor.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>