

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Advanced Alexa Skill Tutorial &mdash; ChatFlow 0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
  

  
    <link rel="top" title="ChatFlow 0.1 documentation" href="index.html"/>
        <link rel="next" title="Advanced Alexa Skill NLU Tutorial" href="alexa_nlu.html"/>
        <link rel="prev" title="Alexa Skill Tutorials" href="alexa.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            
              <a href="http://chatflow.kitt.ai" target="_blank" class="icon icon-home"> ChatFlow
            
          

          
            
            <img src="_static/chatflow-logo.png" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Welcome to ChatFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">ChatFlow Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_a_bot.html">ChatFlow Build A Bot Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="dialogue_nodes.html">Dialogue Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Debug ChatFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="extended_example.html">Extended Example: A Conversational Yelp Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="telegram.html">Telegram Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="facebook.html">Facebook Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="slack.html">Slack Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="twilio.html">Twilio Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="kik.html">Kik Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="skype.html">Skype Bot Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="alexa.html">Alexa Skill Tutorials</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Alexa Skill Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wiseguy-tell-a-knock-knock-joke">WiseGuy: tell a Knock Knock joke</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#wiseguy-video-tutorial">WiseGuy Video Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="#application-overview">Application Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-the-wiseguy-chatflow-app">1. Create the WiseGuy ChatFlow app</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-the-wiseguy-alexa-skill">2. Create the WiseGuy Alexa Skill</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multi-turn-and-state-tracking-explained">Multi turn and state tracking explained</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-global-variable">The <code class="docutils literal"><span class="pre">global</span></code> variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#state-tracking">State tracking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="alexa_nlu.html">Advanced Alexa Skill NLU Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="oauth2.html">OAuth2/Uber Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ChatFlow</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Advanced Alexa Skill Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          <a href="https://groups.google.com/a/kitt.ai/forum/#!forum/chat" class="fa fa-comments" style="color:#55507c" target="_blank"> Forum</a>
        
        
            
            <a href="_sources/alexa_advanced.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced-alexa-skill-tutorial">
<span id="alexa-advanced"></span><h1><a class="toc-backref" href="#id2">Advanced Alexa Skill Tutorial</a><a class="headerlink" href="#advanced-alexa-skill-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#advanced-alexa-skill-tutorial" id="id2">Advanced Alexa Skill Tutorial</a><ul>
<li><a class="reference internal" href="#introduction" id="id3">Introduction</a></li>
<li><a class="reference internal" href="#wiseguy-tell-a-knock-knock-joke" id="id4">WiseGuy: tell a Knock Knock joke</a><ul>
<li><a class="reference internal" href="#wiseguy-video-tutorial" id="id5">WiseGuy Video Tutorial</a></li>
<li><a class="reference internal" href="#application-overview" id="id6">Application Overview</a></li>
<li><a class="reference internal" href="#create-the-wiseguy-chatflow-app" id="id7">1. Create the WiseGuy ChatFlow app</a></li>
<li><a class="reference internal" href="#create-the-wiseguy-alexa-skill" id="id8">2. Create the WiseGuy Alexa Skill</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multi-turn-and-state-tracking-explained" id="id9">Multi turn and state tracking explained</a><ul>
<li><a class="reference internal" href="#the-global-variable" id="id10">The <code class="docutils literal"><span class="pre">global</span></code> variable</a></li>
<li><a class="reference internal" href="#state-tracking" id="id11">State tracking</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id3">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will walk through a more complex Alexa skill that
tells the <em>knock knock</em> joke.</p>
<video width="640" style="display:block; margin: 0 auto;" controls>
  <source src="_static/img/alexa/AlexaKnockKnockDemo.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>
<br> <br> <br><dl class="docutils">
<dt>By the end of this tutorial, you will be able to:</dt>
<dd><ul class="first last simple">
<li>Using multiple intents with slots (entities) in an Alexa sample app</li>
<li>Creating a multi-turn conversation</li>
<li>Managing and tracking dialogue states</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="wiseguy-tell-a-knock-knock-joke">
<h2><a class="toc-backref" href="#id4">WiseGuy: tell a Knock Knock joke</a><a class="headerlink" href="#wiseguy-tell-a-knock-knock-joke" title="Permalink to this headline">¶</a></h2>
<div class="section" id="wiseguy-video-tutorial">
<h3><a class="toc-backref" href="#id5">WiseGuy Video Tutorial</a><a class="headerlink" href="#wiseguy-video-tutorial" title="Permalink to this headline">¶</a></h3>
<iframe width="640" height="360" src="https://www.youtube.com/embed/GTaW4ze1OgM"
    frameborder="0" allowfullscreen></iframe>
<br> <br> <br></div>
<div class="section" id="application-overview">
<h3><a class="toc-backref" href="#id6">Application Overview</a><a class="headerlink" href="#application-overview" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/amzn/alexa-skills-kit-js/tree/master/samples/wiseGuy">Wise Guy</a> is a sample Alexa skill that tells a <em>knock knock</em> joke:</p>
<p><em>You: &#8220;Alexa, ask Wise Guy to tell a joke&#8221;</em></p>
<p><em>Echo: &#8220;Knock knock&#8221;</em></p>
<p><em>You: &#8220;who&#8217;s there?&#8221;</em></p>
<p><em>Echo: &#8220;Beets!&#8221;</em></p>
<p><em>You: &#8220;Beets who?&#8221;</em></p>
<p><em>Echo: &#8220;Beats me!&#8221;</em></p>
<p>This skill highlights Alexa&#8217;s multi-turn ability using dialogue state tracking.
At any given point, the user can ask for help and Alexa will explain how to proceed.</p>
<p>The main source files are the <a class="reference external" href="https://github.com/amzn/alexa-skills-kit-js/tree/master/samples/wiseGuy/speechAssets">Speech Assets</a>
and <a class="reference external" href="https://github.com/amzn/alexa-skills-kit-js/blob/master/samples/wiseGuy/src/index.js">index.js</a> file.</p>
<p>We&#8217;ll see how to easily recreate this application with ChatFlow with a more
intuitive interface.</p>
</div>
<div class="section" id="create-the-wiseguy-chatflow-app">
<span id="create-wiseguy-chatflow-app"></span><h3><a class="toc-backref" href="#id7">1. Create the WiseGuy ChatFlow app</a><a class="headerlink" href="#create-the-wiseguy-chatflow-app" title="Permalink to this headline">¶</a></h3>
<p>Go to <a class="reference external" href="https://chatflow.kitt.ai/">ChatFlow</a> and use the sample application &#8220;Alexa WiseGuy Skill&#8221;:</p>
<img alt="_images/chatflow-wise-guy-app.png" class="align-center" src="_images/chatflow-wise-guy-app.png" />
<p>The application can almost work out of the box. All we need to do is to copy
the &#8220;Final URL&#8221; from the <strong>Alexa In</strong> node after hitting &#8220;DEPLOY&#8221;.</p>
</div>
<div class="section" id="create-the-wiseguy-alexa-skill">
<span id="create-wiseguy-alexa-skill"></span><h3><a class="toc-backref" href="#id8">2. Create the WiseGuy Alexa Skill</a><a class="headerlink" href="#create-the-wiseguy-alexa-skill" title="Permalink to this headline">¶</a></h3>
<p>Now please follow the steps in <a class="reference internal" href="alexa.html#create-an-alexa-skill"><span class="std std-ref">2. Create an Alexa Skill</span></a> to create a skill
for Wise Guy.</p>
<ol class="arabic simple">
<li>In Step <a class="reference internal" href="alexa.html#sample-utterances"><span class="std std-ref">Sample Utterances</span></a>, input
<a class="reference external" href="https://github.com/amzn/alexa-skills-kit-js/tree/master/samples/wiseGuy/speechAssets">Speech Assets</a>.</li>
</ol>
<p><strong>Intent Schema</strong>:</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;intents&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;TellMeAJokeIntent&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;WhosThereIntent&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
     <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;SetupNameWhoIntent&quot;</span><span class="p">,</span>
     <span class="s2">&quot;slots&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;SetupName&quot;</span><span class="p">,</span>
          <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;LIST_OF_SETUP_NAMES&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;AMAZON.HelpIntent&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;AMAZON.StopIntent&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;intent&quot;</span><span class="o">:</span> <span class="s2">&quot;AMAZON.CancelIntent&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>LIST_OF_SETUP_NAMES</strong></p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">to</span>
<span class="nx">beets</span>
<span class="nx">little</span> <span class="nx">Old</span> <span class="nx">Lady</span>
<span class="nx">a</span> <span class="nx">broken</span> <span class="nx">pencil</span>
<span class="nx">snow</span>
<span class="nx">boo</span>
<span class="nx">woo</span>
<span class="nx">spell</span>
<span class="nx">atch</span>
<span class="nx">owls</span>
<span class="nx">berry</span>
</pre></div>
</div>
<p><strong>Sample Utterances</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">TellMeAJokeIntent</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">tell</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">say</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">make</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">give</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">tell</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">say</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">make</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">give</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">a</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">the</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">the</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">what</span><span class="s1">&#39;s a joke</span>
<span class="s1">TellMeAJokeIntent what is a joke</span>
<span class="s1">TellMeAJokeIntent if it can tell me a joke</span>
<span class="s1">TellMeAJokeIntent will it tell me a joke</span>
<span class="s1">TellMeAJokeIntent can it tell me a joke</span>
<span class="s1">TellMeAJokeIntent to tell me a joke</span>
<span class="s1">TellMeAJokeIntent what&#39;</span><span class="nx">s</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">what</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="k">if</span> <span class="nx">it</span> <span class="nx">can</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">will</span> <span class="nx">it</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">can</span> <span class="nx">it</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>
<span class="nx">TellMeAJokeIntent</span> <span class="nx">to</span> <span class="nx">tell</span> <span class="nx">me</span> <span class="nx">a</span> <span class="nx">knock</span> <span class="nx">knock</span> <span class="nx">joke</span>

<span class="nx">WhosThereIntent</span> <span class="nx">who</span> <span class="nx">is</span> <span class="nx">there</span>
<span class="nx">WhosThereIntent</span> <span class="nx">who</span><span class="s1">&#39;s there</span>
<span class="s1">WhosThereIntent who there</span>
<span class="s1">WhosThereIntent who is this</span>
<span class="s1">WhosThereIntent who&#39;</span><span class="nx">s</span> <span class="k">this</span>

<span class="nx">SetupNameWhoIntent</span> <span class="p">{</span><span class="nx">SetupName</span><span class="p">}</span> <span class="nx">who</span>
</pre></div>
</div>
<p>Now we are all set! Use the Service Simulator or your Echo device to test it!</p>
</div>
</div>
<div class="section" id="multi-turn-and-state-tracking-explained">
<span id="multiturn-and-state-tracking-explained"></span><h2><a class="toc-backref" href="#id9">Multi turn and state tracking explained</a><a class="headerlink" href="#multi-turn-and-state-tracking-explained" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-global-variable">
<h3><a class="toc-backref" href="#id10">The <code class="docutils literal"><span class="pre">global</span></code> variable</a><a class="headerlink" href="#the-global-variable" title="Permalink to this headline">¶</a></h3>
<p>Take a look at the <strong>init JOKE_LIST</strong> state node. In it, we have created a
global variable that can be used across the dialogue. It is called <code class="docutils literal"><span class="pre">JOKE_LIST</span></code>
and was set in with the following code:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">JOKE_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="nx">setup</span><span class="o">:</span> <span class="s2">&quot;To&quot;</span><span class="p">,</span> <span class="nx">speechPunchline</span><span class="o">:</span> <span class="s2">&quot;Correct grammar is &lt;break time=\&quot;0.2s\&quot; /&gt; to whom.&quot;</span><span class="p">,</span>
    <span class="nx">cardPunchline</span><span class="o">:</span> <span class="s2">&quot;Correct grammar is &#39;to whom&#39;.&quot;</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">]</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;JOKE_LIST&quot;</span><span class="p">,</span> <span class="nx">JOKE_LIST</span><span class="p">);</span>
</pre></div>
</div>
<p>Then it can be retrieved later in any function or state node by using:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">JOKE_LIST</span> <span class="o">=</span> <span class="k">global</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;JOKE_LIST&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">global</span></code> environment is limited to the current application. One
application cannot access another application&#8217;s <code class="docutils literal"><span class="pre">global</span></code> environment.</p>
<p>In addition, in the <strong>init JOKE_LIST</strong> state node, we initialized the dialogue stage:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="o">.</span><span class="n">kitt</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="state-tracking">
<h3><a class="toc-backref" href="#id11">State tracking</a><a class="headerlink" href="#state-tracking" title="Permalink to this headline">¶</a></h3>
<p>Take a look at the <strong>Tell Me A Joke</strong> state node, it sets up the dialogue stage:</p>
<a class="reference internal image-reference" href="_images/tell-me-a-joke.png"><img alt="_images/tell-me-a-joke.png" class="align-center" src="_images/tell-me-a-joke.png" style="width: 400px;" /></a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the <em>request user input</em> click at the bottom of state node indicates
the router to send message out at this state node <em>right away</em> without
attempting to visit another enter/state node.</p>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="c1">//Select a random joke and store it in the session variables.</span>
<span class="kd">var</span> <span class="nx">jokeID</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">JOKE_LIST</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="c1">//The stage variable tracks the phase of the dialogue.</span>
<span class="c1">//When this function completes, it will be on stage 1.</span>
<span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">stage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">setup</span> <span class="o">=</span> <span class="nx">JOKE_LIST</span><span class="p">[</span><span class="nx">jokeID</span><span class="p">].</span><span class="nx">setup</span><span class="p">;</span>
<span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">speechPunchline</span> <span class="o">=</span> <span class="nx">JOKE_LIST</span><span class="p">[</span><span class="nx">jokeID</span><span class="p">].</span><span class="nx">speechPunchline</span><span class="p">;</span>
<span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">cardPunchline</span> <span class="o">=</span> <span class="nx">JOKE_LIST</span><span class="p">[</span><span class="nx">jokeID</span><span class="p">].</span><span class="nx">cardPunchline</span><span class="p">;</span>
</pre></div>
</div>
<p>Remember that everything in <code class="docutils literal"><span class="pre">msg.kitt</span></code> is maintained by the dialogue router,
persisting over the whole dialogue session. Thus, whenever a new utterance within
the <em>same</em> dialogue session comes in, previous turn&#8217;s <code class="docutils literal"><span class="pre">msg.kitt</span></code> can still be
accessed. <code class="docutils literal"><span class="pre">msg.kitt</span></code> is also assigned to <code class="docutils literal"><span class="pre">sessionAttributes</span></code> <em>outputted</em>
through <strong>Alexa Out</strong> and persisted by the Alexa service. So next time an Alexa
<a class="reference external" href="https://developer.amazon.com/public/solutions/alexa/alexa-skills-kit/docs/alexa-skills-kit-interface-reference#request-format">Request</a>
comes in, the same session attributes can be accessed via <code class="docutils literal"><span class="pre">msg.alexa.session.attributes</span></code>
(maintained by Alexa), or <code class="docutils literal"><span class="pre">msg.kitt</span></code> (maintained by ChatFlow).</p>
<p>The <strong>Who&#8217;s There</strong> state node then advances the dialogue stage by 1 if previous
<code class="docutils literal"><span class="pre">msg.kitt.stage</span> <span class="pre">==</span> <span class="pre">1</span></code>:</p>
<a class="reference internal image-reference" href="_images/whos-there.png"><img alt="_images/whos-there.png" class="align-center" src="_images/whos-there.png" style="width: 400px;" /></a>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">stage</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Retrieve the joke&#39;s setup text.</span>
    <span class="nx">speechText</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">setup</span><span class="p">;</span>

    <span class="c1">//Advance the stage of the dialogue.</span>
    <span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">stage</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="nx">repromptText</span> <span class="o">=</span> <span class="s2">&quot;You can ask, &quot;</span> <span class="o">+</span> <span class="nx">speechText</span> <span class="o">+</span> <span class="s2">&quot; who?&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Similarly, the <strong>Setup Name Who</strong> state node advances the dialogue stage by 1 if previous
<code class="docutils literal"><span class="pre">msg.kitt.stage</span> <span class="pre">==</span> <span class="pre">2</span></code>:</p>
<a class="reference internal image-reference" href="_images/setup-name-who.png"><img alt="_images/setup-name-who.png" class="align-center" src="_images/setup-name-who.png" style="width: 400px;" /></a>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">stage</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">speechText</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">speechPunchline</span><span class="p">;</span>
    <span class="nx">cardOutput</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">cardPunchline</span><span class="p">;</span>
    <span class="nx">msg</span><span class="p">.</span><span class="nx">alexa</span><span class="p">.</span><span class="nx">outputSpeech</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">ssml</span><span class="o">:</span> <span class="s1">&#39;&lt;speak&gt;&#39;</span> <span class="o">+</span> <span class="nx">speechText</span> <span class="o">+</span> <span class="s1">&#39;&lt;/speak&gt;&#39;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;SSML&quot;</span>
    <span class="p">};</span>
    <span class="c1">// the joke completes successfully, end session.</span>
    <span class="nx">msg</span><span class="p">.</span><span class="nx">kitt</span><span class="p">.</span><span class="nx">_session_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In addition, it sets <code class="docutils literal"><span class="pre">msg.kitt._session_ended</span> <span class="pre">=</span> <span class="pre">true;</span></code> because that&#8217;s end of
the <em>knock knock</em> joke!</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="alexa_nlu.html" class="btn btn-neutral float-right" title="Advanced Alexa Skill NLU Tutorial" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="alexa.html" class="btn btn-neutral" title="Alexa Skill Tutorials" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p  style="color:#999;">
        &copy; Copyright 2016, KITT.AI.
      Last updated on Oct 31, 2016.

    </p>
  </div> 

  <div>

    <p>
      Made with <i class="fa fa-heart" style="color:red;"></i> in the city of
      <i class="fa fa-coffee" style="color:#6F4E37;"></i>
      <i class="fa fa-umbrella" style="color:#007FFF;"></i>
      <i class="fa fa-plane" style="color:#0F52BA;"></i>
      <i class="fa fa-diamond" style="color:#50C878;"></i>
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/js/anchor.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>